
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>filemanager.routes.upload_api &#8212; arXiv File Manager Service 0.1 documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for filemanager.routes.upload_api</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Provides routes for the external API.&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">http</span> <span class="k">import</span> <span class="n">HTTPStatus</span>

<span class="kn">from</span> <span class="nn">flask.json</span> <span class="k">import</span> <span class="n">jsonify</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="k">import</span> <span class="n">Blueprint</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">url_for</span><span class="p">,</span> \
    <span class="n">Response</span><span class="p">,</span> <span class="n">make_response</span><span class="p">,</span> <span class="n">send_file</span>
<span class="kn">from</span> <span class="nn">werkzeug.exceptions</span> <span class="k">import</span> <span class="n">NotFound</span><span class="p">,</span> <span class="n">Forbidden</span><span class="p">,</span> <span class="n">Unauthorized</span><span class="p">,</span> \
    <span class="n">InternalServerError</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">BadRequest</span>

<span class="kn">from</span> <span class="nn">arxiv.base</span> <span class="k">import</span> <span class="n">routes</span> <span class="k">as</span> <span class="n">base_routes</span>
<span class="kn">from</span> <span class="nn">arxiv.base</span> <span class="k">import</span> <span class="n">logging</span>
<span class="kn">from</span> <span class="nn">arxiv.users</span> <span class="k">import</span> <span class="n">domain</span> <span class="k">as</span> <span class="n">auth_domain</span>
<span class="kn">from</span> <span class="nn">arxiv.users.auth</span> <span class="k">import</span> <span class="n">scopes</span>
<span class="kn">from</span> <span class="nn">arxiv.users.auth.decorators</span> <span class="k">import</span> <span class="n">scoped</span>

<span class="kn">from</span> <span class="nn">..services</span> <span class="k">import</span> <span class="n">database</span>
<span class="kn">from</span> <span class="nn">..controllers</span> <span class="k">import</span> <span class="n">upload</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">service_log</span><span class="p">,</span> <span class="n">source_log</span><span class="p">,</span> <span class="n">lock</span><span class="p">,</span> \
    <span class="n">release</span><span class="p">,</span> <span class="n">package</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">checkpoint</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">blueprint</span> <span class="o">=</span> <span class="n">Blueprint</span><span class="p">(</span><span class="s1">&#39;upload_api&#39;</span><span class="p">,</span> <span class="vm">__name__</span><span class="p">,</span> <span class="n">url_prefix</span><span class="o">=</span><span class="s1">&#39;/filemanager/api&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="is_owner"><a class="viewcode-back" href="../../../api/filemanager.routes.upload_api.html#filemanager.routes.upload_api.is_owner">[docs]</a><span class="k">def</span> <span class="nf">is_owner</span><span class="p">(</span><span class="n">session</span><span class="p">:</span> <span class="n">auth_domain</span><span class="o">.</span><span class="n">Session</span><span class="p">,</span> <span class="n">upload_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
             <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;User must be the upload owner, or an admin.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">workspace</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">upload_id</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">database</span><span class="o">.</span><span class="n">WorkspaceNotFound</span><span class="p">:</span>
        <span class="c1"># Assume user is creating new upload when upload_id is not found.</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
        <span class="n">owner_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">:</span>
        <span class="n">owner_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">owner_id</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">Unauthorized</span><span class="p">(</span><span class="s1">&#39;No user or client on authenticated session&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">owner_id</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">workspace</span><span class="o">.</span><span class="n">owner_user_id</span><span class="p">)</span></div>


<div class="viewcode-block" id="service_status"><a class="viewcode-back" href="../../../api/filemanager.routes.upload_api.html#filemanager.routes.upload_api.service_status">[docs]</a><span class="nd">@blueprint</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/status&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">service_status</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Readiness endpoint.</span>

<span class="sd">    This route quickly exercises the downstream services/systems upon which</span>
<span class="sd">    the filemanager service depends. If all is well, returns 200 OK. Otherwise,</span>
<span class="sd">    returns 503 Service Unavailable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">response_data</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">status</span><span class="o">.</span><span class="n">service_status</span><span class="p">()</span>
    <span class="n">response</span><span class="p">:</span> <span class="n">Response</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">jsonify</span><span class="p">(</span><span class="n">response_data</span><span class="p">))</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">_update_headers</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">code</span>
    <span class="k">return</span> <span class="n">response</span></div>

<span class="c1"># TODO: Am I able to start off by loading ancillary files?</span>

<div class="viewcode-block" id="new_upload"><a class="viewcode-back" href="../../../api/filemanager.routes.upload_api.html#filemanager.routes.upload_api.new_upload">[docs]</a><span class="nd">@blueprint</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@scoped</span><span class="p">(</span><span class="n">scopes</span><span class="o">.</span><span class="n">WRITE_UPLOAD</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">new_upload</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create workspace and upload files.</span>

<span class="sd">    Initial upload where workspace (upload_id) does not yet exist.</span>

<span class="sd">    This requests creates a new workspace. Upload package is processed normally.</span>

<span class="sd">    Client response include upload_id which is necessary for subsequent requests.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Required file payload</span>
    <span class="n">file</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
        <span class="n">user_or_client</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">user</span>
    <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">:</span>
        <span class="n">user_or_client</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">client</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">Unauthorized</span><span class="p">(</span><span class="s1">&#39;No user or client on authenticated session&#39;</span><span class="p">)</span>

    <span class="c1"># Collect arguments and call main upload controller</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">upload</span><span class="o">.</span><span class="n">upload</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">user_or_client</span><span class="p">)</span>

    <span class="n">response</span><span class="p">:</span> <span class="n">Response</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">jsonify</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">_update_headers</span><span class="p">(</span><span class="n">jsonify</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">headers</span><span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">status_code</span>
    <span class="k">return</span> <span class="n">response</span></div>

<span class="c1"># TODO : Need to set scope correctly once new auth release is minted.</span>

<div class="viewcode-block" id="upload_files_with_checkpoint"><a class="viewcode-back" href="../../../api/filemanager.routes.upload_api.html#filemanager.routes.upload_api.upload_files_with_checkpoint">[docs]</a><span class="nd">@blueprint</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;&lt;int:upload_id&gt;/checkpoint_with_upload&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@scoped</span><span class="p">(</span><span class="n">scopes</span><span class="o">.</span><span class="n">CREATE_UPLOAD_CHECKPOINT</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">upload_files_with_checkpoint</span><span class="p">(</span><span class="n">upload_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Upload files to existing workspace after creating checkpoint.</span>

<span class="sd">    Upload individual files or compressed archive</span>
<span class="sd">    and add to existing upload workspace. Multiple uploads accepted.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    upload_id : int</span>
<span class="sd">        Workspace identifier</span>

<span class="sd">    Note: This request is reserved to users with special scope so</span>
<span class="sd">           we won&#39;t limit access to &#39;is_owner&#39;.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ancillary</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ancillary&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;True&#39;</span>
    <span class="n">file</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="c1"># Attempt to process upload</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">upload</span><span class="o">.</span><span class="n">upload</span><span class="p">(</span><span class="n">upload_id</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span>
                                               <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
                                               <span class="n">ancillary</span><span class="o">=</span><span class="n">ancillary</span><span class="p">,</span>
                                               <span class="n">checkpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span></div>

<div class="viewcode-block" id="upload_files"><a class="viewcode-back" href="../../../api/filemanager.routes.upload_api.html#filemanager.routes.upload_api.upload_files">[docs]</a><span class="nd">@blueprint</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;&lt;int:upload_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@scoped</span><span class="p">(</span><span class="n">scopes</span><span class="o">.</span><span class="n">WRITE_UPLOAD</span><span class="p">,</span> <span class="n">authorizer</span><span class="o">=</span><span class="n">is_owner</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">upload_files</span><span class="p">(</span><span class="n">upload_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Upload files to existing workspace.</span>

<span class="sd">    Upload individual files or compressed archive</span>
<span class="sd">    and add to existing upload workspace. Multiple uploads accepted.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    upload_id : int</span>
<span class="sd">        Workspace identifier</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ancillary</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ancillary&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;True&#39;</span>
    <span class="n">file</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="c1"># Attempt to process upload</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">upload</span><span class="o">.</span><span class="n">upload</span><span class="p">(</span><span class="n">upload_id</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span>
                                               <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
                                               <span class="n">ancillary</span><span class="o">=</span><span class="n">ancillary</span><span class="p">)</span>
    <span class="n">response</span><span class="p">:</span> <span class="n">Response</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">jsonify</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">_update_headers</span><span class="p">(</span><span class="n">jsonify</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">headers</span><span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">status_code</span>
    <span class="k">return</span> <span class="n">response</span></div>


<span class="c1"># Separated this out so that we can support auth granularity. -E</span>
<div class="viewcode-block" id="get_upload_files"><a class="viewcode-back" href="../../../api/filemanager.routes.upload_api.html#filemanager.routes.upload_api.get_upload_files">[docs]</a><span class="nd">@blueprint</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;&lt;int:upload_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@scoped</span><span class="p">(</span><span class="n">scopes</span><span class="o">.</span><span class="n">READ_UPLOAD</span><span class="p">,</span> <span class="n">authorizer</span><span class="o">=</span><span class="n">is_owner</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_upload_files</span><span class="p">(</span><span class="n">upload_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Upload summary.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    upload_id : int</span>
<span class="sd">        Workspace identifier</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">upload</span><span class="o">.</span><span class="n">upload_summary</span><span class="p">(</span><span class="n">upload_id</span><span class="p">)</span>
    <span class="n">response</span><span class="p">:</span> <span class="n">Response</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">jsonify</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">_update_headers</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">status_code</span>
    <span class="k">return</span> <span class="n">response</span></div>


<div class="viewcode-block" id="delete_file"><a class="viewcode-back" href="../../../api/filemanager.routes.upload_api.html#filemanager.routes.upload_api.delete_file">[docs]</a><span class="nd">@blueprint</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;&lt;int:upload_id&gt;/&lt;path:public_file_path&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DELETE&#39;</span><span class="p">])</span>
<span class="nd">@scoped</span><span class="p">(</span><span class="n">scopes</span><span class="o">.</span><span class="n">DELETE_UPLOAD_FILE</span><span class="p">,</span> <span class="n">authorizer</span><span class="o">=</span><span class="n">is_owner</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">delete_file</span><span class="p">(</span><span class="n">upload_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">public_file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Delete individual file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    upload_id : int</span>
<span class="sd">        Workspace identifier</span>
<span class="sd">    public_file_path : str</span>
<span class="sd">        Relative file path that uniquely identifies file to be removed.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">files</span><span class="o">.</span><span class="n">client_delete_file</span><span class="p">(</span>
        <span class="n">upload_id</span><span class="p">,</span>
        <span class="n">public_file_path</span><span class="p">,</span>
        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">user</span> <span class="ow">or</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">client</span>
    <span class="p">)</span>
    <span class="n">response</span><span class="p">:</span> <span class="n">Response</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">jsonify</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">_update_headers</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">status_code</span>
    <span class="k">return</span> <span class="n">response</span></div>


<span class="c1"># File and workspace deletion</span>

<div class="viewcode-block" id="delete_all_files"><a class="viewcode-back" href="../../../api/filemanager.routes.upload_api.html#filemanager.routes.upload_api.delete_all_files">[docs]</a><span class="nd">@blueprint</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;&lt;int:upload_id&gt;/delete_all&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@scoped</span><span class="p">(</span><span class="n">scopes</span><span class="o">.</span><span class="n">WRITE_UPLOAD</span><span class="p">,</span> <span class="n">authorizer</span><span class="o">=</span><span class="n">is_owner</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">delete_all_files</span><span class="p">(</span><span class="n">upload_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Delete all files in specified workspace.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    upload_id : int</span>
<span class="sd">        Workspace identifier</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">files</span><span class="o">.</span><span class="n">client_delete_all_files</span><span class="p">(</span>
        <span class="n">upload_id</span><span class="p">,</span>
        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">user</span> <span class="ow">or</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">client</span>
    <span class="p">)</span>
    <span class="n">response</span><span class="p">:</span> <span class="n">Response</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">jsonify</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">_update_headers</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">status_code</span>
    <span class="k">return</span> <span class="n">response</span></div>



<div class="viewcode-block" id="workspace_delete"><a class="viewcode-back" href="../../../api/filemanager.routes.upload_api.html#filemanager.routes.upload_api.workspace_delete">[docs]</a><span class="nd">@blueprint</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;&lt;int:upload_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DELETE&#39;</span><span class="p">])</span>
<span class="nd">@scoped</span><span class="p">(</span><span class="n">scopes</span><span class="o">.</span><span class="n">DELETE_UPLOAD_WORKSPACE</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">workspace_delete</span><span class="p">(</span><span class="n">upload_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Delete the specified workspace.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    upload_id : int</span>
<span class="sd">        Workspace identifier</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">upload</span><span class="o">.</span><span class="n">delete_workspace</span><span class="p">(</span>
        <span class="n">upload_id</span><span class="p">,</span>
        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">user</span> <span class="ow">or</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">client</span>
    <span class="p">)</span>
    <span class="n">response</span><span class="p">:</span> <span class="n">Response</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">jsonify</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">_update_headers</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">status_code</span>
    <span class="k">return</span> <span class="n">response</span></div>



<span class="c1"># Lock and unlock upload workspace</span>

<div class="viewcode-block" id="lock_workspace"><a class="viewcode-back" href="../../../api/filemanager.routes.upload_api.html#filemanager.routes.upload_api.lock_workspace">[docs]</a><span class="nd">@blueprint</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&lt;int:upload_id&gt;/lock&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@scoped</span><span class="p">(</span><span class="n">scopes</span><span class="o">.</span><span class="n">WRITE_UPLOAD</span><span class="p">,</span> <span class="n">authorizer</span><span class="o">=</span><span class="n">is_owner</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">lock_workspace</span><span class="p">(</span><span class="n">upload_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Lock submission workspace.</span>

<span class="sd">    Lock submission (read-only mode) while other services are</span>
<span class="sd">    processing (major state transitions are occurring).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    upload_id : int</span>
<span class="sd">        Workspace identifier</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="n">upload_lock</span><span class="p">(</span>
        <span class="n">upload_id</span><span class="p">,</span>
        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">user</span> <span class="ow">or</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">client</span>
    <span class="p">)</span>
    <span class="n">response</span><span class="p">:</span> <span class="n">Response</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">jsonify</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">_update_headers</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">status_code</span>
    <span class="k">return</span> <span class="n">response</span></div>


<span class="c1"># This could be thaw or release instead of unlock</span>
<div class="viewcode-block" id="unlock_workspace"><a class="viewcode-back" href="../../../api/filemanager.routes.upload_api.html#filemanager.routes.upload_api.unlock_workspace">[docs]</a><span class="nd">@blueprint</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&lt;int:upload_id&gt;/unlock&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@scoped</span><span class="p">(</span><span class="n">scopes</span><span class="o">.</span><span class="n">WRITE_UPLOAD</span><span class="p">,</span> <span class="n">authorizer</span><span class="o">=</span><span class="n">is_owner</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">unlock_workspace</span><span class="p">(</span><span class="n">upload_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Unlock submission workspace and allow updates.&quot;&quot;&quot;</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="n">upload_unlock</span><span class="p">(</span>
        <span class="n">upload_id</span><span class="p">,</span>
        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">user</span> <span class="ow">or</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">client</span>
    <span class="p">)</span>
    <span class="n">response</span><span class="p">:</span> <span class="n">Response</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">jsonify</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">_update_headers</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">status_code</span>
    <span class="k">return</span> <span class="n">response</span></div>


<span class="c1"># This could be remove or delete instead of release</span>
<div class="viewcode-block" id="release_workspace"><a class="viewcode-back" href="../../../api/filemanager.routes.upload_api.html#filemanager.routes.upload_api.release_workspace">[docs]</a><span class="nd">@blueprint</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&lt;int:upload_id&gt;/release&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@scoped</span><span class="p">(</span><span class="n">scopes</span><span class="o">.</span><span class="n">WRITE_UPLOAD</span><span class="p">,</span> <span class="n">authorizer</span><span class="o">=</span><span class="n">is_owner</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">release_workspace</span><span class="p">(</span><span class="n">upload_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Client indicates they are finished with submission.</span>

<span class="sd">    File management service is free to remove submissions files,</span>
<span class="sd">    or schedule workspace for removal.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">release</span><span class="o">.</span><span class="n">upload_release</span><span class="p">(</span>
        <span class="n">upload_id</span><span class="p">,</span>
        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">user</span> <span class="ow">or</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">client</span>
    <span class="p">)</span>
    <span class="n">response</span><span class="p">:</span> <span class="n">Response</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">jsonify</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">_update_headers</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">status_code</span>
    <span class="k">return</span> <span class="n">response</span></div>


<span class="c1"># This could be remove or delete instead of release</span>
<div class="viewcode-block" id="unrelease_workspace"><a class="viewcode-back" href="../../../api/filemanager.routes.upload_api.html#filemanager.routes.upload_api.unrelease_workspace">[docs]</a><span class="nd">@blueprint</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&lt;int:upload_id&gt;/unrelease&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@scoped</span><span class="p">(</span><span class="n">scopes</span><span class="o">.</span><span class="n">WRITE_UPLOAD</span><span class="p">,</span> <span class="n">authorizer</span><span class="o">=</span><span class="n">is_owner</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">unrelease_workspace</span><span class="p">(</span><span class="n">upload_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Client indicates they are NOT finished with submission.</span>

<span class="sd">    Workspace was previously release by client. Client has changed their</span>
<span class="sd">    mind and does not want to remove workspace.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">release</span><span class="o">.</span><span class="n">upload_unrelease</span><span class="p">(</span>
        <span class="n">upload_id</span><span class="p">,</span>
        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">user</span> <span class="ow">or</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">client</span>
    <span class="p">)</span>
    <span class="n">response</span><span class="p">:</span> <span class="n">Response</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">jsonify</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">_update_headers</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">status_code</span>
    <span class="k">return</span> <span class="n">response</span></div>


<span class="c1"># Get content</span>

<div class="viewcode-block" id="check_upload_content_exists"><a class="viewcode-back" href="../../../api/filemanager.routes.upload_api.html#filemanager.routes.upload_api.check_upload_content_exists">[docs]</a><span class="nd">@blueprint</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&lt;int:upload_id&gt;/content&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;HEAD&#39;</span><span class="p">])</span>
<span class="nd">@scoped</span><span class="p">(</span><span class="n">scopes</span><span class="o">.</span><span class="n">READ_UPLOAD</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_upload_content_exists</span><span class="p">(</span><span class="n">upload_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Verify that upload content exists.</span>

<span class="sd">    Returns an ``ETag`` header with the current source package checksum.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">package</span><span class="o">.</span><span class="n">check_upload_content_exists</span><span class="p">(</span><span class="n">upload_id</span><span class="p">)</span>
    <span class="n">response</span><span class="p">:</span> <span class="n">Response</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">jsonify</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">_update_headers</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">status_code</span>
    <span class="k">return</span> <span class="n">response</span></div>


<div class="viewcode-block" id="get_upload_content"><a class="viewcode-back" href="../../../api/filemanager.routes.upload_api.html#filemanager.routes.upload_api.get_upload_content">[docs]</a><span class="nd">@blueprint</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&lt;int:upload_id&gt;/content&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@scoped</span><span class="p">(</span><span class="n">scopes</span><span class="o">.</span><span class="n">READ_UPLOAD</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_upload_content</span><span class="p">(</span><span class="n">upload_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the upload content as a compressed tarball.</span>

<span class="sd">    Returns a stream with mimetype ``application/tar+gzip``, and an ``ETag``</span>
<span class="sd">    header with the current source package checksum.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Request for upload content: </span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span>
                 <span class="n">upload_id</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">upload_id</span><span class="p">))</span>
    <span class="c1"># Note: status_code is not used</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">package</span><span class="o">.</span><span class="n">get_upload_content</span><span class="p">(</span>
        <span class="n">upload_id</span><span class="p">,</span>
        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">user</span> <span class="ow">or</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">client</span>
    <span class="p">)</span>
    <span class="n">response</span><span class="p">:</span> <span class="n">Response</span> <span class="o">=</span> <span class="n">send_file</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mimetype</span><span class="o">=</span><span class="s2">&quot;application/tar+gzip&quot;</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">_update_headers</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">status_code</span>
    <span class="c1"># response.set_etag(headers.get(&#39;ETag&#39;))</span>
    <span class="k">return</span> <span class="n">response</span></div>

<div class="viewcode-block" id="check_file_exists"><a class="viewcode-back" href="../../../api/filemanager.routes.upload_api.html#filemanager.routes.upload_api.check_file_exists">[docs]</a><span class="nd">@blueprint</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&lt;int:upload_id&gt;/&lt;path:public_file_path&gt;/content&#39;</span><span class="p">,</span>
                 <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;HEAD&#39;</span><span class="p">])</span>
<span class="nd">@scoped</span><span class="p">(</span><span class="n">scopes</span><span class="o">.</span><span class="n">READ_UPLOAD</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_file_exists</span><span class="p">(</span><span class="n">upload_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">public_file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Verify specified file exists.</span>

<span class="sd">    Returns an ``ETag`` header with the current source file checksum.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span> <span class="o">=</span> \
        <span class="n">files</span><span class="o">.</span><span class="n">check_upload_file_content_exists</span><span class="p">(</span><span class="n">upload_id</span><span class="p">,</span> <span class="n">public_file_path</span><span class="p">)</span>

    <span class="n">response</span><span class="p">:</span> <span class="n">Response</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">jsonify</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">_update_headers</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">status_code</span>
    <span class="k">return</span> <span class="n">response</span></div>


<div class="viewcode-block" id="get_file_content"><a class="viewcode-back" href="../../../api/filemanager.routes.upload_api.html#filemanager.routes.upload_api.get_file_content">[docs]</a><span class="nd">@blueprint</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&lt;int:upload_id&gt;/&lt;path:public_file_path&gt;/content&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@scoped</span><span class="p">(</span><span class="n">scopes</span><span class="o">.</span><span class="n">READ_UPLOAD</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_file_content</span><span class="p">(</span><span class="n">upload_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">public_file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return content of specified file.</span>

<span class="sd">    :param upload_id:</span>
<span class="sd">    :param public_file_path:</span>
<span class="sd">    :return: File content.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">files</span><span class="o">.</span><span class="n">get_upload_file_content</span><span class="p">(</span>
        <span class="n">upload_id</span><span class="p">,</span>
        <span class="n">public_file_path</span><span class="p">,</span>
        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">user</span> <span class="ow">or</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">client</span>
    <span class="p">)</span>
    <span class="n">response</span><span class="p">:</span> <span class="n">Response</span> <span class="o">=</span> <span class="n">send_file</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mimetype</span><span class="o">=</span><span class="s2">&quot;application/*&quot;</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">_update_headers</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">status_code</span>
    <span class="c1"># response.set_etag(headers.get(&#39;ETag&#39;))</span>
    <span class="k">return</span> <span class="n">response</span></div>


<span class="c1"># Get logs</span>

<div class="viewcode-block" id="check_upload_source_log_exists"><a class="viewcode-back" href="../../../api/filemanager.routes.upload_api.html#filemanager.routes.upload_api.check_upload_source_log_exists">[docs]</a><span class="nd">@blueprint</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&lt;int:upload_id&gt;/log&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;HEAD&#39;</span><span class="p">])</span>
<span class="nd">@scoped</span><span class="p">(</span><span class="n">scopes</span><span class="o">.</span><span class="n">READ_UPLOAD_LOGS</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_upload_source_log_exists</span><span class="p">(</span><span class="n">upload_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check that upload source log exists.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    upload_id: int</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Returns an ``ETag`` header with the current source package checksum.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span> <span class="o">=</span> \
        <span class="n">source_log</span><span class="o">.</span><span class="n">check_upload_source_log_exists</span><span class="p">(</span><span class="n">upload_id</span><span class="p">)</span>
    <span class="n">response</span><span class="p">:</span> <span class="n">Response</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">jsonify</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">_update_headers</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">status_code</span>
    <span class="k">return</span> <span class="n">response</span></div>


<div class="viewcode-block" id="get_upload_source_log"><a class="viewcode-back" href="../../../api/filemanager.routes.upload_api.html#filemanager.routes.upload_api.get_upload_source_log">[docs]</a><span class="nd">@blueprint</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&lt;int:upload_id&gt;/log&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@scoped</span><span class="p">(</span><span class="n">scopes</span><span class="o">.</span><span class="n">READ_UPLOAD_LOGS</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_upload_source_log</span><span class="p">(</span><span class="n">upload_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get upload workspace log.</span>

<span class="sd">    Get the upload source log for specified upload workspace. This provides</span>
<span class="sd">    details of all upload/deletion/errors/warnings for specified workspace.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    upload_id : int</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    The source.log for specified upload workspace.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">source_log</span><span class="o">.</span><span class="n">get_upload_source_log</span><span class="p">(</span>
        <span class="n">upload_id</span><span class="p">,</span>
        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">user</span> <span class="ow">or</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">client</span>
    <span class="p">)</span>
    <span class="n">response</span><span class="p">:</span> <span class="n">Response</span> <span class="o">=</span> <span class="n">send_file</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mimetype</span><span class="o">=</span><span class="s2">&quot;application/tar+gzip&quot;</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">_update_headers</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">status_code</span>
    <span class="c1"># response.set_etag(headers.get(&#39;ETag&#39;))</span>
    <span class="k">return</span> <span class="n">response</span></div>


<div class="viewcode-block" id="check_upload_service_log_exists"><a class="viewcode-back" href="../../../api/filemanager.routes.upload_api.html#filemanager.routes.upload_api.check_upload_service_log_exists">[docs]</a><span class="nd">@blueprint</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/log&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;HEAD&#39;</span><span class="p">])</span>
<span class="nd">@scoped</span><span class="p">(</span><span class="n">scopes</span><span class="o">.</span><span class="n">READ_UPLOAD_SERVICE_LOGS</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_upload_service_log_exists</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check that upload source log exists.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Returns an ``ETag`` header with the current source package checksum.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">service_log</span><span class="o">.</span><span class="n">check_upload_service_log_exists</span><span class="p">()</span>
    <span class="n">response</span><span class="p">:</span> <span class="n">Response</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">jsonify</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">_update_headers</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">status_code</span>
    <span class="k">return</span> <span class="n">response</span></div>


<div class="viewcode-block" id="get_upload_service_log"><a class="viewcode-back" href="../../../api/filemanager.routes.upload_api.html#filemanager.routes.upload_api.get_upload_service_log">[docs]</a><span class="nd">@blueprint</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/log&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@scoped</span><span class="p">(</span><span class="n">scopes</span><span class="o">.</span><span class="n">READ_UPLOAD_SERVICE_LOGS</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_upload_service_log</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get upload file manager service log.</span>

<span class="sd">    Return the top level file manager service log that records high-level</span>
<span class="sd">    events/requests along with important errors/warnings.</span>

<span class="sd">    Does not include etails for a specific upload workspace.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    The log file for upload file manager service.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Note: status_code not used</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">service_log</span><span class="o">.</span><span class="n">get_upload_service_log</span><span class="p">(</span>
        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">user</span> <span class="ow">or</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">client</span>
    <span class="p">)</span>
    <span class="n">response</span><span class="p">:</span> <span class="n">Response</span> <span class="o">=</span> <span class="n">send_file</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mimetype</span><span class="o">=</span><span class="s2">&quot;application/tar+gzip&quot;</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">_update_headers</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
    <span class="c1"># response.set_etag(headers.get(&#39;ETag&#39;))</span>
    <span class="k">return</span> <span class="n">response</span></div>

<span class="c1"># Checkpoint related requests</span>
<span class="c1">#</span>
<span class="c1"># create</span>
<span class="c1"># list</span>
<span class="c1"># remove</span>
<span class="c1"># remove_all</span>
<span class="c1"># restore</span>
<span class="c1"># checkpoint exists</span>
<span class="c1"># checkpoint download</span>

<span class="c1"># Create checkpoint</span>
<div class="viewcode-block" id="create_checkpoint"><a class="viewcode-back" href="../../../api/filemanager.routes.upload_api.html#filemanager.routes.upload_api.create_checkpoint">[docs]</a><span class="nd">@blueprint</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;&lt;int:upload_id&gt;/checkpoint&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@scoped</span><span class="p">(</span><span class="n">scopes</span><span class="o">.</span><span class="n">CREATE_UPLOAD_CHECKPOINT</span><span class="p">,</span> <span class="n">authorizer</span><span class="o">=</span><span class="n">is_owner</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">create_checkpoint</span><span class="p">(</span><span class="n">upload_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create checkpoint from current files in specified workspace.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    upload_id : int</span>
<span class="sd">        Workspace identifier</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="o">.</span><span class="n">create_checkpoint</span><span class="p">(</span><span class="n">upload_id</span><span class="p">,</span>
                                                       <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">code</span><span class="p">,</span> <span class="n">headers</span></div>

<span class="c1"># List checkpoints</span>
<div class="viewcode-block" id="list_checkpoints"><a class="viewcode-back" href="../../../api/filemanager.routes.upload_api.html#filemanager.routes.upload_api.list_checkpoints">[docs]</a><span class="nd">@blueprint</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;&lt;int:upload_id&gt;/list_checkpoints&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@scoped</span><span class="p">(</span><span class="n">scopes</span><span class="o">.</span><span class="n">READ_UPLOAD_CHECKPOINT</span><span class="p">,</span> <span class="n">authorizer</span><span class="o">=</span><span class="n">is_owner</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">list_checkpoints</span><span class="p">(</span><span class="n">upload_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    List checkpoint files associated with specified workspace.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    upload_id : int</span>
<span class="sd">        Workspace identifier</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="o">.</span><span class="n">list_checkpoints</span><span class="p">(</span><span class="n">upload_id</span><span class="p">,</span>
                                                      <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">code</span><span class="p">,</span> <span class="n">headers</span></div>

<span class="c1"># Restore checkpoint</span>
<div class="viewcode-block" id="restore_checkpoint"><a class="viewcode-back" href="../../../api/filemanager.routes.upload_api.html#filemanager.routes.upload_api.restore_checkpoint">[docs]</a><span class="nd">@blueprint</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;&lt;int:upload_id&gt;/restore_checkpoint/&lt;checkpoint_checksum&gt;&#39;</span><span class="p">,</span>
                 <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@scoped</span><span class="p">(</span><span class="n">scopes</span><span class="o">.</span><span class="n">RESTORE_UPLOAD_CHECKPOINT</span><span class="p">,</span> <span class="n">authorizer</span><span class="o">=</span><span class="n">is_owner</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">restore_checkpoint</span><span class="p">(</span><span class="n">upload_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">checkpoint_checksum</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create checkpoint from current files in specified workspace.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    upload_id : int</span>
<span class="sd">        Workspace identifier</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="o">.</span><span class="n">restore_checkpoint</span><span class="p">(</span><span class="n">upload_id</span><span class="p">,</span>
                                                        <span class="n">checkpoint_checksum</span><span class="p">,</span>
                                                        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">code</span><span class="p">,</span> <span class="n">headers</span></div>

<span class="c1"># TODO: Need to revise scopes!!! Leave open during development.</span>

<span class="c1"># Checkpoint remove and remove all</span>

<div class="viewcode-block" id="delete_checkpoint"><a class="viewcode-back" href="../../../api/filemanager.routes.upload_api.html#filemanager.routes.upload_api.delete_checkpoint">[docs]</a><span class="nd">@blueprint</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;&lt;int:upload_id&gt;/delete_checkpoint/&lt;checkpoint_checksum&gt;&#39;</span><span class="p">,</span>
                 <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DELETE&#39;</span><span class="p">])</span>
<span class="nd">@scoped</span><span class="p">(</span><span class="n">scopes</span><span class="o">.</span><span class="n">DELETE_UPLOAD_CHECKPOINT</span><span class="p">,</span> <span class="n">authorizer</span><span class="o">=</span><span class="n">is_owner</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">delete_checkpoint</span><span class="p">(</span><span class="n">upload_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">checkpoint_checksum</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Delete individual checkpoint file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    upload_id : int</span>
<span class="sd">        Workspace identifier</span>
<span class="sd">    checkpoint_checksum : str</span>
<span class="sd">        Checkpoint checksum that uniquely identifies file to be removed.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="o">.</span><span class="n">delete_checkpoint</span><span class="p">(</span><span class="n">upload_id</span><span class="p">,</span>
                                                       <span class="n">checkpoint_checksum</span><span class="p">,</span>
                                                       <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">code</span><span class="p">,</span> <span class="n">headers</span></div>

<span class="c1"># File and workspace deletion</span>

<div class="viewcode-block" id="delete_all_checkpoints"><a class="viewcode-back" href="../../../api/filemanager.routes.upload_api.html#filemanager.routes.upload_api.delete_all_checkpoints">[docs]</a><span class="nd">@blueprint</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;&lt;int:upload_id&gt;/delete_all_checkpoints&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@scoped</span><span class="p">(</span><span class="n">scopes</span><span class="o">.</span><span class="n">DELETE_UPLOAD_CHECKPOINT</span><span class="p">,</span> <span class="n">authorizer</span><span class="o">=</span><span class="n">is_owner</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">delete_all_checkpoints</span><span class="p">(</span><span class="n">upload_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Delete all checkpoint files in specified workspace.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    upload_id : int</span>
<span class="sd">        Workspace identifier</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span> \
        <span class="o">=</span> <span class="n">checkpoint</span><span class="o">.</span><span class="n">delete_all_checkpoints</span><span class="p">(</span><span class="n">upload_id</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span></div>


<span class="c1"># Checkpoint exists/download</span>
<div class="viewcode-block" id="check_checkpoint_file_exists"><a class="viewcode-back" href="../../../api/filemanager.routes.upload_api.html#filemanager.routes.upload_api.check_checkpoint_file_exists">[docs]</a><span class="nd">@blueprint</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&lt;int:upload_id&gt;/checkpoint/&lt;checkpoint_checksum&gt;&#39;</span><span class="p">,</span>
                 <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;HEAD&#39;</span><span class="p">])</span>
<span class="nd">@scoped</span><span class="p">(</span><span class="n">scopes</span><span class="o">.</span><span class="n">READ_UPLOAD_CHECKPOINT</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_checkpoint_file_exists</span><span class="p">(</span><span class="n">upload_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">checkpoint_checksum</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Verify that upload content exists.</span>

<span class="sd">    Returns an ``ETag`` header with the current source package checksum.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">headers</span> \
        <span class="o">=</span> <span class="n">checkpoint</span><span class="o">.</span><span class="n">check_checkpoint_file_exists</span><span class="p">(</span><span class="n">upload_id</span><span class="p">,</span>
                                                 <span class="n">checkpoint_checksum</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">_update_headers</span><span class="p">(</span><span class="n">jsonify</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">headers</span><span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">code</span>
    <span class="k">return</span> <span class="n">response</span></div>


<div class="viewcode-block" id="get_checkpoint_file"><a class="viewcode-back" href="../../../api/filemanager.routes.upload_api.html#filemanager.routes.upload_api.get_checkpoint_file">[docs]</a><span class="nd">@blueprint</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&lt;int:upload_id&gt;/checkpoint/&lt;checkpoint_checksum&gt;&#39;</span><span class="p">,</span>
                 <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@scoped</span><span class="p">(</span><span class="n">scopes</span><span class="o">.</span><span class="n">READ_UPLOAD_CHECKPOINT</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_checkpoint_file</span><span class="p">(</span><span class="n">upload_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">checkpoint_checksum</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the upload content as a compressed tarball.</span>

<span class="sd">    Returns a stream with mimetype ``application/tar+gzip``, and an ``ETag``</span>
<span class="sd">    header with the current source package checksum.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Request for upload content: </span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span>
                 <span class="n">upload_id</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">upload_id</span><span class="p">))</span>
    <span class="c1"># Note: status_code is not used</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="o">.</span><span class="n">get_checkpoint_file</span><span class="p">(</span><span class="n">upload_id</span><span class="p">,</span>
                                                      <span class="n">checkpoint_checksum</span><span class="p">,</span>
                                                      <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
    <span class="n">response</span><span class="p">:</span> <span class="n">Response</span> <span class="o">=</span> <span class="n">send_file</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mimetype</span><span class="o">=</span><span class="s2">&quot;application/tar+gzip&quot;</span><span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">set_etag</span><span class="p">(</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ETag&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">response</span></div>




<span class="c1"># Exception handling</span>


<div class="viewcode-block" id="handle_exception"><a class="viewcode-back" href="../../../api/filemanager.routes.upload_api.html#filemanager.routes.upload_api.handle_exception">[docs]</a><span class="nd">@blueprint</span><span class="o">.</span><span class="n">errorhandler</span><span class="p">(</span><span class="n">NotFound</span><span class="p">)</span>
<span class="nd">@blueprint</span><span class="o">.</span><span class="n">errorhandler</span><span class="p">(</span><span class="n">InternalServerError</span><span class="p">)</span>
<span class="nd">@blueprint</span><span class="o">.</span><span class="n">errorhandler</span><span class="p">(</span><span class="n">Forbidden</span><span class="p">)</span>
<span class="nd">@blueprint</span><span class="o">.</span><span class="n">errorhandler</span><span class="p">(</span><span class="n">Unauthorized</span><span class="p">)</span>
<span class="nd">@blueprint</span><span class="o">.</span><span class="n">errorhandler</span><span class="p">(</span><span class="n">BadRequest</span><span class="p">)</span>
<span class="nd">@blueprint</span><span class="o">.</span><span class="n">errorhandler</span><span class="p">(</span><span class="ne">NotImplementedError</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">handle_exception</span><span class="p">(</span><span class="n">error</span><span class="p">:</span> <span class="n">HTTPException</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    JSON-ify the error response.</span>

<span class="sd">    This works just like the handlers in zero.routes.ui, but instead of</span>
<span class="sd">    rendering a template we are JSON-ifying the response. Note that we are</span>
<span class="sd">    registering the same error handler for several different exceptions, since</span>
<span class="sd">    we aren&#39;t doing anything that is specific to a particular exception.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="n">error</span><span class="o">.</span><span class="n">description</span><span class="p">})</span>

    <span class="c1"># Each Werkzeug HTTP exception has a class attribute called ``code``; we</span>
    <span class="c1"># can use that to set the status code on the response.</span>
    <span class="n">response</span><span class="p">:</span> <span class="n">Response</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">error</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span></div>


<span class="k">def</span> <span class="nf">_update_headers</span><span class="p">(</span><span class="n">response</span><span class="p">:</span> <span class="n">Response</span><span class="p">,</span> <span class="n">headers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">headers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>     <span class="c1"># Avoid duplicate headers.</span>
            <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>   <span class="c1"># type: ignore</span>
        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>   <span class="c1"># type: ignore</span>
    <span class="c1"># if &#39;Content-Length&#39; in response.headers:</span>
    <span class="c1">#     response.headers.remove(&#39;Content-Length&#39;) # type: ignore</span>
    <span class="k">return</span> <span class="n">response</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">arXiv File Manager Service</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../architecture.html">File management service architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/modules.html">filemanager</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, arXiv-NG Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>